---

- name: Copy contiv YAML file 
  template: 
    src: contiv-base.yaml.j2
    dest: /tmp/contiv.yaml
 
- name: Install Contiv Networking
  command: "kubectl --kubeconfig /etc/kubernetes/admin.conf apply -f /tmp/contiv.yaml"
 
# Contiv provides name resolution via the EP name. Comment this out to keep kube-dns
- name: Remove kube-dns
  command: kubectl --kubeconfig /etc/kubernetes/admin.conf {{ item }}
  with_items:
    - delete deployment/kube-dns -n kube-system
    - delete svc kube-dns -n kube-system

- name: wait for netmaster to become active.
  wait_for:
    port: 9999
    delay: 10
    timeout: 900
      
- name: Ensure there is a netmaster entry in /etc/hosts for this machine. Otherwise netctl doesn't work.  
  lineinfile:
    dest: /etc/hosts
    line: "{{ master_ip }} netmaster"
 
- pause:
    minutes: 2
    prompt: "Make sure network pods are started"